/* WE NEED TO REPLACE ALL SORTS OF SAYING NOT AVAILABLE INFORMATION TO NULL*/
UPDATE gadm.gadm_tot SET gid_0=NULL WHERE gid_0='<Null>';
UPDATE gadm.gadm_tot SET name_0=NULL WHERE name_0='<Null>';
UPDATE gadm.gadm_tot SET varname_0=NULL WHERE varname_0='<Null>';
UPDATE gadm.gadm_tot SET gid_1=NULL WHERE gid_1='<Null>';
UPDATE gadm.gadm_tot SET name_1=NULL WHERE name_1='<Null>';
UPDATE gadm.gadm_tot SET varname_1=NULL WHERE varname_1='<Null>';
UPDATE gadm.gadm_tot SET nl_name_1=NULL WHERE nl_name_1='<Null>';
UPDATE gadm.gadm_tot SET iso_1=NULL WHERE iso_1='<Null>';
UPDATE gadm.gadm_tot SET hasc_1=NULL WHERE hasc_1='<Null>';
UPDATE gadm.gadm_tot SET cc_1=NULL WHERE cc_1='<Null>';
UPDATE gadm.gadm_tot SET type_1=NULL WHERE type_1='<Null>';
UPDATE gadm.gadm_tot SET engtype_1=NULL WHERE engtype_1='<Null>';
UPDATE gadm.gadm_tot SET validfr_1=NULL WHERE validfr_1='<Null>';
UPDATE gadm.gadm_tot SET gid_2=NULL WHERE gid_2='<Null>';
UPDATE gadm.gadm_tot SET name_2=NULL WHERE name_2='<Null>';
UPDATE gadm.gadm_tot SET varname_2=NULL WHERE varname_2='<Null>';
UPDATE gadm.gadm_tot SET nl_name_2=NULL WHERE nl_name_2='<Null>';
UPDATE gadm.gadm_tot SET hasc_2=NULL WHERE hasc_2='<Null>';
UPDATE gadm.gadm_tot SET cc_2=NULL WHERE cc_2='<Null>';
UPDATE gadm.gadm_tot SET type_2=NULL WHERE type_2='<Null>';
UPDATE gadm.gadm_tot SET engtype_2=NULL WHERE engtype_2='<Null>';
UPDATE gadm.gadm_tot SET validfr_2=NULL WHERE validfr_2='<Null>';
UPDATE gadm.gadm_tot SET gid_3=NULL WHERE gid_3='<Null>';
UPDATE gadm.gadm_tot SET name_3=NULL WHERE name_3='<Null>';
UPDATE gadm.gadm_tot SET varname_3=NULL WHERE varname_3='<Null>';
UPDATE gadm.gadm_tot SET nl_name_3=NULL WHERE nl_name_3='<Null>';
UPDATE gadm.gadm_tot SET hasc_3=NULL WHERE hasc_3='<Null>';
UPDATE gadm.gadm_tot SET cc_3=NULL WHERE cc_3='<Null>';
UPDATE gadm.gadm_tot SET type_3=NULL WHERE type_3='<Null>';
UPDATE gadm.gadm_tot SET engtype_3=NULL WHERE engtype_3='<Null>';
UPDATE gadm.gadm_tot SET validfr_3=NULL WHERE validfr_3='<Null>';
UPDATE gadm.gadm_tot SET gid_4=NULL WHERE gid_4='<Null>';
UPDATE gadm.gadm_tot SET name_4=NULL WHERE name_4='<Null>';
UPDATE gadm.gadm_tot SET varname_4=NULL WHERE varname_4='<Null>';
UPDATE gadm.gadm_tot SET cc_4=NULL WHERE cc_4='<Null>';
UPDATE gadm.gadm_tot SET type_4=NULL WHERE type_4='<Null>';
UPDATE gadm.gadm_tot SET engtype_4=NULL WHERE engtype_4='<Null>';
UPDATE gadm.gadm_tot SET validfr_4=NULL WHERE validfr_4='<Null>';
UPDATE gadm.gadm_tot SET gid_5=NULL WHERE gid_5='<Null>';
UPDATE gadm.gadm_tot SET name_5=NULL WHERE name_5='<Null>';
UPDATE gadm.gadm_tot SET cc_5=NULL WHERE cc_5='<Null>';
UPDATE gadm.gadm_tot SET type_5=NULL WHERE type_5='<Null>';
UPDATE gadm.gadm_tot SET engtype_5=NULL WHERE engtype_5='<Null>';
UPDATE gadm.gadm_tot SET governedby=NULL WHERE governedby='<Null>';
UPDATE gadm.gadm_tot SET sovereign=NULL WHERE sovereign='<Null>';
UPDATE gadm.gadm_tot SET disputedby=NULL WHERE disputedby='<Null>';
UPDATE gadm.gadm_tot SET region=NULL WHERE region='<Null>';
UPDATE gadm.gadm_tot SET varregion=NULL WHERE varregion='<Null>';
UPDATE gadm.gadm_tot SET country=NULL WHERE country='<Null>';
UPDATE gadm.gadm_tot SET continent=NULL WHERE continent='<Null>';
UPDATE gadm.gadm_tot SET subcont=NULL WHERE subcont='<Null>';

UPDATE gadm.gadm_tot SET gid_0=NULL WHERE gid_0='Unknown';
UPDATE gadm.gadm_tot SET name_0=NULL WHERE name_0='Unknown';
UPDATE gadm.gadm_tot SET varname_0=NULL WHERE varname_0='Unknown';
UPDATE gadm.gadm_tot SET gid_1=NULL WHERE gid_1='Unknown';
UPDATE gadm.gadm_tot SET name_1=NULL WHERE name_1='Unknown';
UPDATE gadm.gadm_tot SET varname_1=NULL WHERE varname_1='Unknown';
UPDATE gadm.gadm_tot SET nl_name_1=NULL WHERE nl_name_1='Unknown';
UPDATE gadm.gadm_tot SET iso_1=NULL WHERE iso_1='Unknown';
UPDATE gadm.gadm_tot SET hasc_1=NULL WHERE hasc_1='Unknown';
UPDATE gadm.gadm_tot SET cc_1=NULL WHERE cc_1='Unknown';
UPDATE gadm.gadm_tot SET type_1=NULL WHERE type_1='Unknown';
UPDATE gadm.gadm_tot SET engtype_1=NULL WHERE engtype_1='Unknown';
UPDATE gadm.gadm_tot SET validfr_1=NULL WHERE validfr_1='Unknown';
UPDATE gadm.gadm_tot SET gid_2=NULL WHERE gid_2='Unknown';
UPDATE gadm.gadm_tot SET name_2=NULL WHERE name_2='Unknown';
UPDATE gadm.gadm_tot SET varname_2=NULL WHERE varname_2='Unknown';
UPDATE gadm.gadm_tot SET nl_name_2=NULL WHERE nl_name_2='Unknown';
UPDATE gadm.gadm_tot SET hasc_2=NULL WHERE hasc_2='Unknown';
UPDATE gadm.gadm_tot SET cc_2=NULL WHERE cc_2='Unknown';
UPDATE gadm.gadm_tot SET type_2=NULL WHERE type_2='Unknown';
UPDATE gadm.gadm_tot SET engtype_2=NULL WHERE engtype_2='Unknown';
UPDATE gadm.gadm_tot SET validfr_2=NULL WHERE validfr_2='Unknown';
UPDATE gadm.gadm_tot SET gid_3=NULL WHERE gid_3='Unknown';
UPDATE gadm.gadm_tot SET name_3=NULL WHERE name_3='Unknown';
UPDATE gadm.gadm_tot SET varname_3=NULL WHERE varname_3='Unknown';
UPDATE gadm.gadm_tot SET nl_name_3=NULL WHERE nl_name_3='Unknown';
UPDATE gadm.gadm_tot SET hasc_3=NULL WHERE hasc_3='Unknown';
UPDATE gadm.gadm_tot SET cc_3=NULL WHERE cc_3='Unknown';
UPDATE gadm.gadm_tot SET type_3=NULL WHERE type_3='Unknown';
UPDATE gadm.gadm_tot SET engtype_3=NULL WHERE engtype_3='Unknown';
UPDATE gadm.gadm_tot SET validfr_3=NULL WHERE validfr_3='Unknown';
UPDATE gadm.gadm_tot SET gid_4=NULL WHERE gid_4='Unknown';
UPDATE gadm.gadm_tot SET name_4=NULL WHERE name_4='Unknown';
UPDATE gadm.gadm_tot SET varname_4=NULL WHERE varname_4='Unknown';
UPDATE gadm.gadm_tot SET cc_4=NULL WHERE cc_4='Unknown';
UPDATE gadm.gadm_tot SET type_4=NULL WHERE type_4='Unknown';
UPDATE gadm.gadm_tot SET engtype_4=NULL WHERE engtype_4='Unknown';
UPDATE gadm.gadm_tot SET validfr_4=NULL WHERE validfr_4='Unknown';
UPDATE gadm.gadm_tot SET gid_5=NULL WHERE gid_5='Unknown';
UPDATE gadm.gadm_tot SET name_5=NULL WHERE name_5='Unknown';
UPDATE gadm.gadm_tot SET cc_5=NULL WHERE cc_5='Unknown';
UPDATE gadm.gadm_tot SET type_5=NULL WHERE type_5='Unknown';
UPDATE gadm.gadm_tot SET engtype_5=NULL WHERE engtype_5='Unknown';
UPDATE gadm.gadm_tot SET governedby=NULL WHERE governedby='Unknown';
UPDATE gadm.gadm_tot SET sovereign=NULL WHERE sovereign='Unknown';
UPDATE gadm.gadm_tot SET disputedby=NULL WHERE disputedby='Unknown';
UPDATE gadm.gadm_tot SET region=NULL WHERE region='Unknown';
UPDATE gadm.gadm_tot SET varregion=NULL WHERE varregion='Unknown';
UPDATE gadm.gadm_tot SET country=NULL WHERE country='Unknown';
UPDATE gadm.gadm_tot SET continent=NULL WHERE continent='Unknown';
UPDATE gadm.gadm_tot SET subcont=NULL WHERE subcont='Unknown';


UPDATE gadm.gadm_tot SET name_1=NULL WHERE name_1~'^ *n\.a\.';
UPDATE gadm.gadm_tot SET name_2=NULL WHERE name_2~'^ *n\.a\.';
UPDATE gadm.gadm_tot SET name_3=NULL WHERE name_3~'^ *n\.a\.';
UPDATE gadm.gadm_tot SET name_4=NULL WHERE name_4~'^ *n\.a\.';
UPDATE gadm.gadm_tot SET name_5=NULL WHERE name_5~'^ *n\.a\.';

/*OTHER CORRECTIONS*/

UPDATE gadm.gadm_tot SET name_1='Cork' WHERE gid_1='IRL.4_1' AND name_1='Cork City';
UPDATE gadm.gadm_tot SET gid_1='GBR.4_1' WHERE gid_1<>'GBR.4_1' AND name_1='Wales';
UPDATE gadm.gadm_tot SET gid_1='GBR.1_1' WHERE gid_1 IS NULL  AND name_1='England';
UPDATE gadm.gadm_tot SET gid_1='GBR.3_1' WHERE gid_1<>'GBR.3_1' AND name_1='Scotland';
UPDATE gadm.gadm_tot SET gid_1='MHL.24_1' WHERE name_1='Rongelap';
UPDATE gadm.gadm_tot SET gid_1='NLD.15_1' WHERE name_1='Zuid Hollandse Meren';

--- ADM0

-- SELECT COUNT(DISTINCT gid_0)=(SELECT COUNT(*) FROM (SELECT DISTINCT gid_0,name_0 FROM gadm.gadm_tot) a) FROM gadm.gadm_tot;

CREATE TABLE gadm.gadm_adm0 AS(
WITH collect_varname_0 AS(
  SELECT gid_0,name_0,ARRAY_AGG(varname_0) varname_0
  FROM(
    SELECT DISTINCT gid_0,name_0,UNNEST(STRING_TO_ARRAY(varname_0,'|')) varname_0
    FROM gadm.gadm_tot) a
  GROUP BY gid_0, name_0
), majo_cases AS(
  SELECT DISTINCT ON (gid_0,name_0) gid_0,name_0,governedby,sovereign,country,
  regexp_split_to_array(disputedby,'(, (and)? ?)|(,? ?and )') disputedby
  FROM(
    SELECT gid_0,name_0,governedby,sovereign,country,disputedby,count(*) nb
    FROM gadm.gadm_tot
    GROUP BY gid_0,name_0,governedby,sovereign,country,disputedby) a
  ORDER BY gid_0,name_0,nb DESC
)
SELECT gid_0, name_0,
  cv0.varname_0,
  mc.governedby, mc.sovereign, mc.country, mc.disputedby,
  ST_Union(geom) geom
FROM gadm.gadm_tot
LEFT JOIN collect_varname_0 cv0 USING(gid_0,name_0)
LEFT JOIN majo_cases mc USING(gid_0,name_0)
WHERE gid_0 IS NOT NULL
GROUP BY gid_0, name_0,
  cv0.varname_0,
  mc.governedby, mc.sovereign, mc.country, mc.disputedby
)
;

ALTER TABLE gadm.gadm_adm0 ADD PRIMARY KEY (gid_0);
UPDATE gadm.gadm_adm0 SET geom=ST_MakeValid(geom) WHERE NOT ST_IsValid(geom);
CREATE INDEX gadm_gadm_adm0_geom_idx ON gadm.gadm_adm0 USING GIST(geom);

--ADM1

--SELECT COUNT(DISTINCT gid_1)=(SELECT COUNT(*) FROM (SELECT DISTINCT gid_1,name_1 FROM gadm.gadm_tot WHERE gid_1 IS NOT NULL) a) FROM gadm.gadm_tot WHERE gid_1 IS NOT NULL;

CREATE TABLE gadm.gadm_adm1 AS(
WITH collect_varname_1 as(
  SELECT gid_1,name_1,ARRAY_AGG(varname_1) varname_1
  FROM(
    SELECT DISTINCT gid_1,name_1,UNNEST(STRING_TO_ARRAY(varname_1,'|')) varname_1
    FROM gadm.gadm_tot
    WHERE gid_1 IS NOT NULL AND gid_1 <> '?') a
  GROUP BY gid_1, name_1
),
collect_nl_name_1 AS(
  SELECT gid_1,name_1,ARRAY_AGG(nl_name_1) nl_name_1
  FROM(
    SELECT DISTINCT gid_1,name_1,UNNEST(STRING_TO_ARRAY(nl_name_1,'|')) nl_name_1
    FROM gadm.gadm_tot
    WHERE gid_1 IS NOT NULL AND gid_1 <> '?') a
  GROUP BY gid_1, name_1
),
collect_varregion AS(
  SELECT gid_1,name_1,ARRAY_AGG(varregion) varregion
  FROM(
    SELECT DISTINCT gid_1,name_1,UNNEST(STRING_TO_ARRAY(varregion,'|')) varregion
    FROM gadm.gadm_tot
    WHERE gid_1 IS NOT NULL AND gid_1 <> '?') a
  GROUP BY gid_1, name_1
),
majo_cases AS(
  SELECT DISTINCT ON (gid_1,name_1) gid_1,name_1,iso_1,hasc_1,cc_1,type_1,engtype_1,region
  FROM(
    SELECT gid_1,name_1,iso_1,hasc_1,cc_1,type_1,engtype_1,region,count(*) nb
    FROM gadm.gadm_tot
    WHERE gid_1 IS NOT NULL AND gid_1 <> '?'
    GROUP BY gid_1,name_1,iso_1,hasc_1,cc_1,type_1,engtype_1,region) a
  ORDER BY gid_1,name_1,nb DESC
)
SELECT gid_1, name_1, gid_0,
  cv1.varname_1,
  cn1.nl_name_1,
  mc.iso_1,mc.hasc_1,mc.cc_1,mc.type_1,mc.engtype_1,mc.region,
  cvr.varregion,
  ST_Union(geom) geom
FROM gadm.gadm_tot
LEFT JOIN collect_varname_1 cv1 USING(gid_1,name_1)
LEFT JOIN collect_nl_name_1 cn1 USING(gid_1,name_1)
LEFT JOIN collect_varregion cvr USING(gid_1,name_1)
LEFT JOIN majo_cases mc USING(gid_1,name_1)
WHERE gid_1 IS NOT NULL AND gid_1 <> '?'
GROUP BY gid_1, name_1, gid_0,
  cv1.varname_1,
  cn1.nl_name_1,
  mc.iso_1,mc.hasc_1,mc.cc_1,mc.type_1,mc.engtype_1,mc.region,
  cvr.varregion
);

ALTER TABLE gadm.gadm_adm1 ADD PRIMARY KEY (gid_1);
UPDATE gadm.gadm_adm1 SET gid_0=NULL WHERE gid_0 NOT IN (SELECT gid_0 FROM gadm.gadm_adm0);
ALTER TABLE gadm.gadm_adm1 ADD CONSTRAINT gadm_adm1_gadm_adm0_fk FOREIGN KEY (gid_0) REFERENCES gadm.gadm_adm0 (gid_0);
UPDATE gadm.gadm_adm1 SET geom=ST_MakeValid(geom) WHERE NOT ST_IsValid(geom);
CREATE INDEX gadm_gadm_adm1_geom_idx ON gadm.gadm_adm1 USING GIST(geom);

-- ADM2
-- SELECT COUNT(DISTINCT gid_2)=(SELECT COUNT(*) FROM (SELECT DISTINCT gid_2,name_2 FROM gadm.gadm_tot WHERE gid_2 IS NOT NULL) a) FROM gadm.gadm_tot WHERE gid_2 IS NOT NULL;


/* There are a lot of problematic cases, particularly in Great Britain, but also a few in other places where the gid does not correspond to the name, I will arbitrarily consider that the name  is right and correct these cases, but it might be the other way around in some cases... no way to check!*/

/* So what we will do is not integrate the adm2 for the case which have the same gid_2 as the problematic ones, or the same gid_1 AND name_2. We will mark them in the column 'pb_2' of gadm_tot (NULL si il n'y a pas de gid_2, false s'il n y a pas de problême, true si probleme)*/
ALTER TABLE gadm.gadm_tot ADD COLUMN pb_2 boolean default NULL;
UPDATE gadm.gadm_tot SET pb_2=false WHERE gid_2 IS NOT NULL;
WITH a AS(
SELECT gid_1,gid_2,ARRAY_AGG(DISTINCT name_2) name_2
FROM gadm.gadm_tot
GROUP BY gid_1,gid_2
HAVING count(DISTINCT name_2) >1
), b AS(
SELECT gid_1,gid_2,UNNEST(name_2) name_2
FROM a
),c AS(
SELECT uid
FROM gadm.gadm_tot gt
JOIN b ON gt.gid_2=b.gid_2 OR (gt.gid_1=b.gid_1 AND b.name_2=gt.name_2)
)
UPDATE gadm.gadm_tot gt
SET pb_2=true
FROM c
WHERE gt.uid=c.uid;

SELECT COUNT(DISTINCT gid_2)=(SELECT COUNT(*) FROM (SELECT DISTINCT gid_2,name_2 FROM gadm.gadm_tot WHERE gid_2 IS NOT NULL AND NOT pb_2) a) FROM gadm.gadm_tot WHERE gid_2 IS NOT NULL AND NOT pb_2;

CREATE TABLE gadm.gadm_adm2 AS(
WITH collect_varname_2 as(
  SELECT gid_2,name_2,ARRAY_AGG(varname_2) varname_2
  FROM(
    SELECT DISTINCT gid_2,name_2,UNNEST(STRING_TO_ARRAY(varname_2,'|')) varname_2
    FROM gadm.gadm_tot
    WHERE gid_2 IS NOT NULL AND gid_2 <>'?' AND NOT pb_2) a
  GROUP BY gid_2, name_2
),
collect_nl_name_2 AS(
  SELECT gid_2,name_2,ARRAY_AGG(nl_name_2) nl_name_2
  FROM(
    SELECT DISTINCT gid_2,name_2,UNNEST(STRING_TO_ARRAY(nl_name_2,'|')) nl_name_2
    FROM gadm.gadm_tot
    WHERE gid_2 IS NOT NULL AND gid_2 <>'?' AND NOT pb_2) a
  GROUP BY gid_2, name_2
),
majo_cases AS(
  SELECT DISTINCT ON (gid_2,name_2) gid_2,name_2,hasc_2,cc_2,type_2,engtype_2,validfr_2, gid_1
  FROM(
    SELECT gid_2,name_2,hasc_2,cc_2,type_2,engtype_2,validfr_2, gid_1,count(*) nb
    FROM gadm.gadm_tot
    WHERE gid_2 IS NOT NULL AND gid_2 <>'?' AND NOT pb_2
    GROUP BY gid_2,name_2,hasc_2,cc_2,type_2,engtype_2,validfr_2,gid_1) a
  ORDER BY gid_2,name_2,nb DESC
)
SELECT gid_2, name_2,
  mc.gid_1,
  cv2.varname_2,
  cn2.nl_name_2,
  mc.hasc_2,mc.cc_2,mc.type_2,mc.engtype_2,mc.validfr_2,
  ST_Union(geom) geom
FROM gadm.gadm_tot
LEFT JOIN collect_varname_2 cv2 USING(gid_2,name_2)
LEFT JOIN collect_nl_name_2 cn2 USING(gid_2,name_2)
LEFT JOIN majo_cases mc USING(gid_2,name_2)
WHERE gid_2 IS NOT NULL AND gid_2 <>'?' AND NOT pb_2
GROUP BY gid_2, name_2,
  mc.gid_1,
  cv2.varname_2,
  cn2.nl_name_2,
  mc.hasc_2,mc.cc_2,mc.type_2,mc.engtype_2,mc.validfr_2
);

ALTER TABLE gadm.gadm_adm2 ADD PRIMARY KEY (gid_2);
UPDATE gadm.gadm_adm2 SET gid_1=NULL WHERE gid_1 NOT IN (SELECT gid_1 FROM gadm.gadm_adm1);
ALTER TABLE gadm.gadm_adm2 ADD CONSTRAINT gadm_adm2_gadm_adm1_fk FOREIGN KEY (gid_1) REFERENCES gadm.gadm_adm1 (gid_1);
UPDATE gadm.gadm_adm2 SET geom=ST_MakeValid(geom) WHERE NOT ST_IsValid(geom);
CREATE INDEX gadm_gadm_adm2_geom_idx ON gadm.gadm_adm2 USING GIST(geom);

--ADM3


SELECT gid_3,ARRAY_AGG(DISTINCT name_3)
FROM gadm.gadm_tot
GROUP BY gid_3
HAVING count(DISTINCT name_3) >1;


ALTER TABLE gadm.gadm_tot ADD COLUMN pb_3 boolean default NULL;
UPDATE gadm.gadm_tot SET pb_3=false WHERE gid_3 IS NOT NULL;
WITH a AS(
SELECT gid_2,gid_3,ARRAY_AGG(DISTINCT name_3) name_3
FROM gadm.gadm_tot
GROUP BY gid_2,gid_3
HAVING count(DISTINCT name_3) >1
), b AS(
SELECT gid_2,gid_3,UNNEST(name_3) name_3
FROM a
),c AS(
SELECT uid
FROM gadm.gadm_tot gt
JOIN b ON gt.gid_3=b.gid_3 OR (gt.gid_2=b.gid_2 AND b.name_3=gt.name_3)
)
UPDATE gadm.gadm_tot gt
SET pb_3=true
FROM c
WHERE gt.uid=c.uid;


SELECT COUNT(DISTINCT gid_3)=(SELECT COUNT(*) FROM (SELECT DISTINCT gid_3,name_3 FROM gadm.gadm_tot WHERE gid_3 IS NOT NULL AND NOT pb_3) a) FROM gadm.gadm_tot WHERE gid_3 IS NOT NULL AND NOT pb_3;

SELECT gid_3,ARRAY_AGG(DISTINCT name_3)
FROM gadm.gadm_tot
WHERE NOT pb_3
GROUP BY gid_3
HAVING count(DISTINCT name_3) >1;


CREATE TABLE gadm.gadm_adm3 AS(
WITH collect_varname_3 as(
  SELECT gid_3,name_3,ARRAY_AGG(varname_3) varname_3
  FROM(
    SELECT DISTINCT gid_3,name_3,UNNEST(STRING_TO_ARRAY(varname_3,'|')) varname_3
    FROM gadm.gadm_tot
    WHERE gid_3 IS NOT NULL AND gid_3 <>'?' AND NOT pb_3) a
  GROUP BY gid_3, name_3
),
collect_nl_name_3 AS(
  SELECT gid_3,name_3,ARRAY_AGG(nl_name_3) nl_name_3
  FROM(
    SELECT DISTINCT gid_3,name_3,UNNEST(STRING_TO_ARRAY(nl_name_3,'|')) nl_name_3
    FROM gadm.gadm_tot
    WHERE gid_3 IS NOT NULL AND gid_3 <>'?' AND NOT pb_3) a
  GROUP BY gid_3, name_3
),
majo_cases AS(
  SELECT DISTINCT ON (gid_3,name_3) gid_3,name_3,hasc_3,cc_3,type_3,engtype_3,validfr_3, gid_2
  FROM(
    SELECT gid_3,name_3,hasc_3,cc_3,type_3,engtype_3,validfr_3, gid_2,count(*) nb
    FROM gadm.gadm_tot
    WHERE gid_3 IS NOT NULL AND gid_3 <>'?' AND NOT pb_3
    GROUP BY gid_3,name_3,hasc_3,cc_3,type_3,engtype_3,validfr_3,gid_2) a
  ORDER BY gid_3,name_3,nb DESC
)
SELECT gid_3, name_3,
  mc.gid_2,
  cv3.varname_3,
  cn3.nl_name_3,
  mc.hasc_3,mc.cc_3,mc.type_3,mc.engtype_3,mc.validfr_3,
  ST_Union(geom) geom
FROM gadm.gadm_tot
LEFT JOIN collect_varname_3 cv3 USING(gid_3,name_3)
LEFT JOIN collect_nl_name_3 cn3 USING(gid_3,name_3)
LEFT JOIN majo_cases mc USING(gid_3,name_3)
WHERE gid_3 IS NOT NULL AND gid_3 <>'?' AND NOT pb_3 AND name_3 IS NOT NULL
GROUP BY gid_3, name_3,
  mc.gid_2,
  cv3.varname_3,
  cn3.nl_name_3,
  mc.hasc_3,mc.cc_3,mc.type_3,mc.engtype_3,mc.validfr_3
);

ALTER TABLE gadm.gadm_adm3 ADD PRIMARY KEY (gid_3);
UPDATE gadm.gadm_adm3 SET gid_2=NULL WHERE gid_2 NOT IN (SELECT gid_2 FROM gadm.gadm_adm2);
ALTER TABLE gadm.gadm_adm3 ADD CONSTRAINT gadm_adm3_gadm_adm2_fk FOREIGN KEY (gid_2) REFERENCES gadm.gadm_adm2 (gid_2);
UPDATE gadm.gadm_adm3 SET geom=ST_MakeValid(geom) WHERE NOT ST_IsValid(geom);
CREATE INDEX gadm_gadm_adm3_geom_idx ON gadm.gadm_adm3 USING GIST(geom);

--ADM4


SELECT gid_4,ARRAY_AGG(DISTINCT name_4)
FROM gadm.gadm_tot
GROUP BY gid_4
HAVING count(DISTINCT name_4) >1;


ALTER TABLE gadm.gadm_tot ADD COLUMN pb_4 boolean default NULL;
UPDATE gadm.gadm_tot SET pb_4=false WHERE gid_4 IS NOT NULL;
WITH a AS(
SELECT gid_3,gid_4,ARRAY_AGG(DISTINCT name_4) name_4
FROM gadm.gadm_tot
GROUP BY gid_3,gid_4
HAVING count(DISTINCT name_4) >1
), b AS(
SELECT gid_3,gid_4,UNNEST(name_4) name_4
FROM a
),c AS(
SELECT uid
FROM gadm.gadm_tot gt
JOIN b ON gt.gid_4=b.gid_4 OR (gt.gid_3=b.gid_3 AND b.name_4=gt.name_4)
)
UPDATE gadm.gadm_tot gt
SET pb_4=true
FROM c
WHERE gt.uid=c.uid;


SELECT COUNT(DISTINCT gid_4)=(SELECT COUNT(*) FROM (SELECT DISTINCT gid_4,name_4 FROM gadm.gadm_tot WHERE gid_4 IS NOT NULL AND NOT pb_4) a) FROM gadm.gadm_tot WHERE gid_4 IS NOT NULL AND NOT pb_4;

SELECT gid_4,ARRAY_AGG(DISTINCT name_4)
FROM gadm.gadm_tot
WHERE NOT pb_4
GROUP BY gid_4
HAVING count(DISTINCT name_4) >1;


CREATE TABLE gadm.gadm_adm4 AS(
WITH collect_varname_4 as(
  SELECT gid_4,name_4,ARRAY_AGG(varname_4) varname_4
  FROM(
    SELECT DISTINCT gid_4,name_4,UNNEST(STRING_TO_ARRAY(varname_4,'|')) varname_4
    FROM gadm.gadm_tot
    WHERE gid_4 IS NOT NULL AND gid_4 <>'?' AND NOT pb_4) a
  GROUP BY gid_4, name_4
),
majo_cases AS(
  SELECT DISTINCT ON (gid_4,name_4) gid_4,name_4,cc_4,type_4,engtype_4,validfr_4, gid_3
  FROM(
    SELECT gid_4,name_4,cc_4,type_4,engtype_4,validfr_4, gid_3,count(*) nb
    FROM gadm.gadm_tot
    WHERE gid_4 IS NOT NULL AND gid_4 <>'?' AND NOT pb_4
    GROUP BY gid_4,name_4,cc_4,type_4,engtype_4,validfr_4,gid_3) a
  ORDER BY gid_4,name_4,nb DESC
)
SELECT gid_4, name_4,
  mc.gid_3,
  cv4.varname_4,
  mc.cc_4,mc.type_4,mc.engtype_4,mc.validfr_4,
  ST_Union(geom) geom
FROM gadm.gadm_tot
LEFT JOIN collect_varname_4 cv4 USING(gid_4,name_4)
LEFT JOIN majo_cases mc USING(gid_4,name_4)
WHERE gid_4 IS NOT NULL AND gid_4 <>'?' AND NOT pb_4 AND name_4 IS NOT NULL
GROUP BY gid_4, name_4,
  mc.gid_3,
  cv4.varname_4,
  mc.cc_4,mc.type_4,mc.engtype_4,mc.validfr_4
);

ALTER TABLE gadm.gadm_adm4 ADD PRIMARY KEY (gid_4);
UPDATE gadm.gadm_adm4 SET gid_3=NULL WHERE gid_3 NOT IN (SELECT gid_3 FROM gadm.gadm_adm3);
ALTER TABLE gadm.gadm_adm4 ADD CONSTRAINT gadm_adm4_gadm_adm3_fk FOREIGN KEY (gid_3) REFERENCES gadm.gadm_adm3 (gid_3);
UPDATE gadm.gadm_adm4 SET geom=ST_MakeValid(geom) WHERE NOT ST_IsValid(geom);
CREATE INDEX gadm_gadm_adm4_geom_idx ON gadm.gadm_adm4 USING GIST(geom);

--ADM5


SELECT gid_5,ARRAY_AGG(DISTINCT name_5)
FROM gadm.gadm_tot
GROUP BY gid_5
HAVING count(DISTINCT name_5) >1;


ALTER TABLE gadm.gadm_tot ADD COLUMN pb_5 boolean default NULL;
UPDATE gadm.gadm_tot SET pb_5=false WHERE gid_5 IS NOT NULL;
WITH a AS(
SELECT gid_4,gid_5,ARRAY_AGG(DISTINCT name_5) name_5
FROM gadm.gadm_tot
GROUP BY gid_4,gid_5
HAVING count(DISTINCT name_5) >1
), b AS(
SELECT gid_4,gid_5,UNNEST(name_5) name_5
FROM a
),c AS(
SELECT uid
FROM gadm.gadm_tot gt
JOIN b ON gt.gid_5=b.gid_5 OR (gt.gid_4=b.gid_4 AND b.name_5=gt.name_5)
)
UPDATE gadm.gadm_tot gt
SET pb_5=true
FROM c
WHERE gt.uid=c.uid;


SELECT COUNT(DISTINCT gid_5)=(SELECT COUNT(*) FROM (SELECT DISTINCT gid_5,name_5 FROM gadm.gadm_tot WHERE gid_5 IS NOT NULL AND NOT pb_5) a) FROM gadm.gadm_tot WHERE gid_5 IS NOT NULL AND NOT pb_5;

SELECT gid_5,ARRAY_AGG(DISTINCT name_5)
FROM gadm.gadm_tot
WHERE NOT pb_5
GROUP BY gid_5
HAVING count(DISTINCT name_5) >1;


CREATE TABLE gadm.gadm_adm5 AS(
WITH majo_cases AS(
  SELECT DISTINCT ON (gid_5,name_5) gid_5,name_5,cc_5,type_5,engtype_5, gid_4
  FROM(
    SELECT gid_5,name_5,cc_5,type_5,engtype_5, gid_4,count(*) nb
    FROM gadm.gadm_tot
    WHERE gid_5 IS NOT NULL AND gid_5 <>'?' AND NOT pb_5
    GROUP BY gid_5,name_5,cc_5,type_5,engtype_5,gid_4) a
  ORDER BY gid_5,name_5,nb DESC
)
SELECT gid_5, name_5,
  mc.gid_4,
  mc.cc_5,mc.type_5,mc.engtype_5,
  ST_Union(geom) geom
FROM gadm.gadm_tot
LEFT JOIN majo_cases mc USING(gid_5,name_5)
WHERE gid_5 IS NOT NULL AND gid_5 <>'?' AND NOT pb_5 AND name_5 IS NOT NULL
GROUP BY gid_5, name_5,
  mc.gid_4,
  mc.cc_5,mc.type_5,mc.engtype_5
);

ALTER TABLE gadm.gadm_adm5 ADD PRIMARY KEY (gid_5);
UPDATE gadm.gadm_adm5 SET gid_4=NULL WHERE gid_4 NOT IN (SELECT gid_4 FROM gadm.gadm_adm4);
ALTER TABLE gadm.gadm_adm5 ADD CONSTRAINT gadm_adm5_gadm_adm4_fk FOREIGN KEY (gid_4) REFERENCES gadm.gadm_adm4 (gid_4);
UPDATE gadm.gadm_adm5 SET geom=ST_MakeValid(geom) WHERE NOT ST_IsValid(geom);
CREATE INDEX gadm_gadm_adm5_geom_idx ON gadm.gadm_adm5 USING GIST(geom);



